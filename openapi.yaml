openapi: 3.0.3
info:
  title: Orienteering Game API
  description: REST API for the scavenger hunt game - serves iOS and Android apps
  version: 1.0.0
  contact:
    name: PauliusRap
    url: https://github.com/PauliusRap

servers:
  - url: http://localhost:8080
    description: Local development
  - url: https://orienteering-game-api.fly.dev
    description: Production (Fly.io)

tags:
  - name: Auth
    description: User authentication
  - name: Users
    description: User profile management
  - name: Hunts
    description: Scavenger hunt management
  - name: Progress
    description: Player progress tracking
  - name: Leaderboards
    description: Rankings and scores

paths:
  /health:
    get:
      summary: Health check
      description: Returns server health status for load balancers
      responses:
        '200':
          description: Server is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok

  /api/auth/register:
    post:
      tags: [Auth]
      summary: Register a new user
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '400':
          description: Invalid input or user already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/login:
    post:
      tags: [Auth]
      summary: Login and get JWT token
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          description: Invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/users/me:
    get:
      tags: [Users]
      summary: Get current user profile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserResponse'
        '401':
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/hunts:
    get:
      tags: [Hunts]
      summary: List all available hunts
      responses:
        '200':
          description: List of hunts
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Hunt'

  /api/hunts/{id}:
    get:
      tags: [Hunts]
      summary: Get hunt details with clues
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Hunt details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Hunt'
        '404':
          description: Hunt not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/hunts/{id}/start:
    post:
      tags: [Progress]
      summary: Start a hunt (creates progress record)
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: string
      responses:
        '201':
          description: Hunt started
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Progress'
        '200':
          description: Hunt already started (returns existing progress)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Progress'
        '404':
          description: Hunt not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/progress:
    get:
      tags: [Progress]
      summary: List all active hunts for current user
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of progress records
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Progress'

  /api/progress/{huntId}:
    get:
      tags: [Progress]
      summary: Get detailed progress for a specific hunt
      security:
        - bearerAuth: []
      parameters:
        - name: huntId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Progress details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Progress'
        '404':
          description: Progress not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/progress/{huntId}/checkin:
    post:
      tags: [Progress]
      summary: Check-in at a location (GPS proximity validation)
      description: |
        Validates that the player is within the clue's radius using GPS coordinates.
        Uses Haversine formula to calculate distance in meters.
      security:
        - bearerAuth: []
      parameters:
        - name: huntId
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CheckInRequest'
      responses:
        '200':
          description: Check-in successful, progress updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Progress'
        '400':
          description: Not within clue radius or hunt completed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '404':
          description: Progress not found (start hunt first)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/leaderboards/{huntId}:
    get:
      tags: [Leaderboards]
      summary: Get leaderboard for a specific hunt
      security:
        - bearerAuth: []
      parameters:
        - name: huntId
          in: path
          required: true
          schema:
            type: string
      responses:
        '200':
          description: Hunt leaderboard
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HuntLeaderboard'
        '404':
          description: Hunt not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/leaderboards/global:
    get:
      tags: [Leaderboards]
      summary: Get global leaderboard across all hunts
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Global leaderboard
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GlobalLeaderboard'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: JWT token obtained from /api/auth/login

  schemas:
    RegisterRequest:
      type: object
      required: [username, email, password]
      properties:
        username:
          type: string
          example: johndoe
        email:
          type: string
          format: email
          example: john@example.com
        password:
          type: string
          format: password
          minLength: 6
          example: secretpassword

    LoginRequest:
      type: object
      required: [username, password]
      properties:
        username:
          type: string
          description: Username or email
          example: johndoe
        password:
          type: string
          format: password
          example: secretpassword

    TokenResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT token (valid for 24 hours)
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

    UserResponse:
      type: object
      properties:
        id:
          type: string
          example: id_1234567890
        username:
          type: string
          example: johndoe
        email:
          type: string
          example: john@example.com
        createdAt:
          type: string
          format: date-time

    Hunt:
      type: object
      properties:
        id:
          type: string
          example: id_1234567890
        name:
          type: string
          example: City Sprint
        description:
          type: string
          example: Navigate city clues to finish
        clues:
          type: array
          items:
            $ref: '#/components/schemas/Clue'
        createdAt:
          type: string
          format: date-time

    Clue:
      type: object
      properties:
        id:
          type: string
          example: id_1234567891
        huntId:
          type: string
          example: id_1234567890
        order:
          type: integer
          description: Clue sequence number (1-indexed)
          example: 1
        hint:
          type: string
          description: The riddle/clue text
          example: Start near the old clock tower.
        latitude:
          type: number
          format: double
          example: 37.7739
        longitude:
          type: number
          format: double
          example: -122.4313
        radius:
          type: number
          format: double
          description: Proximity radius in meters
          example: 60

    Progress:
      type: object
      properties:
        id:
          type: string
          example: id_1234567892
        userId:
          type: string
          example: id_1234567890
        huntId:
          type: string
          example: id_1234567890
        currentClueIndex:
          type: integer
          description: Index of the next clue to solve (0-indexed)
          example: 1
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
          description: Null if not completed
        checkedCount:
          type: integer
          description: Number of clues checked in
          example: 1

    CheckInRequest:
      type: object
      required: [latitude, longitude]
      properties:
        latitude:
          type: number
          format: double
          example: 37.7739
        longitude:
          type: number
          format: double
          example: -122.4313

    HuntLeaderboard:
      type: object
      properties:
        hunt:
          type: string
          example: City Sprint
        leadership:
          type: array
          items:
            type: object
            properties:
              userId:
                type: string
              username:
                type: string
              score:
                type: integer
                description: Number of clues completed
              completed:
                type: boolean

    GlobalLeaderboard:
      type: object
      properties:
        globalLeaders:
          type: array
          items:
            type: object
            properties:
              UserID:
                type: string
              Username:
                type: string
              Score:
                type: integer
                description: Aggregate score across all hunts

    Error:
      type: object
      properties:
        error:
          type: string
          example: invalid credentials
